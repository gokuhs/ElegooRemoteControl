stages:
  - sync
  - build
  - release

variables:
  QT_VERSION: "6.4.0"

# 2. Local Job
build_linux:
  stage: build
  image: ubuntu:22.04
  rules:
    - if: $CI_COMMIT_TAG # Compile only Release
  before_script:
    - apt-get update
    # Paquetes necesarios. Mantenemos 'file', 'strace' (opcional) y 'desktop-file-utils'
    - apt-get install -y build-essential cmake git python3-pip wget file gettext-base patchelf libfuse2 libgl1-mesa-dev libxkbcommon-x11-0 libegl1-mesa libfontconfig1 libdbus-1-3 libglib2.0-0 libxcb-cursor0 libxcb-icccm4 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-shape0 libxcb-sync1 libxcb-xfixes0 libxcb-xinerama0 libxcb-xkb1 libxkbcommon-dev libnss3 libasound2 fuse desktop-file-utils
    - pip3 install aqtinstall
    - aqt install-qt linux desktop 6.4.0 gcc_64 --outputdir /opt/qt
    - export PATH=/opt/qt/6.4.0/gcc_64/bin:$PATH
    - export Qt6_DIR=/opt/qt/6.4.0/gcc_64
  script:
    # 1. Configuración y Compilación
    - mkdir -p build
    - cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
    - cmake --build build --config Release
    
    # 2. Preparar iconos
    - if [ -f packaging/default.desktop.in ]; then envsubst < packaging/default.desktop.in > build/default.desktop; else cp packaging/default.desktop build/default.desktop; fi
    - cp packaging/elegoo-remote-control.png build/elegoo-remote-control.png
    
    # 3. Definir versión
    - export VERSION=$(git describe --tags --always || echo "v0.0.0")
    
    # 4. Descargar herramienta
    - wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage" -O linuxdeployqt.AppImage
    - chmod a+x linuxdeployqt.AppImage
    
    # 5. Generar AppImage
    - cd build
    - echo "Generando AppImage versión $VERSION..."
    
    # Limpieza de entorno Qt para no confundir a la herramienta
    - unset QT_PLUGIN_PATH
    - unset LD_LIBRARY_PATH
    - unset QML2_IMPORT_PATH
    
    # FIX 1: Evitar uso de FUSE (necesario en Docker)
    - export APPIMAGE_EXTRACT_AND_RUN=1
    
    # FIX 2 (DEFINITIVO): Añadimos '-no-strip' para evitar el crash
    - QT_QPA_PLATFORM=offscreen ${CI_PROJECT_DIR}/linuxdeployqt.AppImage default.desktop -appimage -no-strip -unsupported-allow-new-glibc -qmake=/opt/qt/6.4.0/gcc_64/bin/qmake -verbose=2
    
    # 6. Renombrar y mover
    - mv ElegooRemoteControl*.AppImage ElegooRemoteControl-linux-x86_64.AppImage
  artifacts:
    when: always # Guardar artifacts incluso si falla para ver el log de strace
    paths:
      - build/ElegooRemoteControl-linux-x86_64.AppImage
      - trace_deploy.txt

# 3. Publish Gitlab
create_gitlab_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - echo "Creando release en GitLab Local..."
  release:
    name: "Release $CI_COMMIT_TAG"
    description: "Versión Linux compilada localmente."
    tag_name: "$CI_COMMIT_TAG"
    assets:
      links:
        - name: "Linux AppImage"
          url: "${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/build/ElegooRemoteControl-linux-x86_64.AppImage"