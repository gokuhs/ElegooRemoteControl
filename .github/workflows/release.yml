name: Build and Release

on:
  release:
    types: [published]

jobs:
  build-linux:
    name: Build Linux (AppImage)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          arch: 'gcc_64'
          modules: 'qtbase qttools'
          aqt-tool-concurrency: '4'
          
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build with CMake
        run: cmake --build build --config Release --parallel

      - name: Download linuxdeployqt
        run: |
          wget -c -nv "https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage"
          chmod a+x linuxdeployqt-continuous-x86_64.AppImage

      - name: Build AppImage
        run: |
          # linuxdeployqt necesita que las traducciones (.qm) est√©n en el lugar correcto
          mkdir -p build/translations
          cp build/translations/*.qm build/
          # Ejecutar linuxdeployqt
          ./linuxdeployqt-continuous-x86_64.AppImage build/ElegooRemoteControl -appimage -bundle-non-qt-libs

      - name: Upload AppImage to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./ElegooRemoteControl-x86_64.AppImage
          asset_name: ElegooRemoteControl-Linux-x86_64.AppImage
          asset_content_type: application/x-appimage

  build-windows:
    name: Build Windows (MSVC)
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build with CMake
        run: cmake --build build --config Release --parallel

      - name: Package Windows build
        run: |
          # Crear un directorio para el paquete
          mkdir release
          # Copiar el ejecutable
          cp build/Release/ElegooRemoteControl.exe release/
          # Copiar las traducciones
          mkdir release/translations
          cp build/Release/saturn_es.qm release/translations/
          # Usar windeployqt para copiar todas las DLLs de Qt necesarias
          windeployqt.exe --release --dir release release/ElegooRemoteControl.exe
          # Crear un archivo ZIP
          7z a -tzip ElegooRemoteControl-Windows-x64.zip ./release/*

      - name: Upload Windows ZIP to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./ElegooRemoteControl-Windows-x64.zip
          asset_name: ElegooRemoteControl-Windows-x64.zip
          asset_content_type: application/zip

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'mac'
          target: 'desktop'

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build with CMake
        run: cmake --build build --config Release --parallel

      - name: Package macOS build
        run: macdeployqt build/ElegooRemoteControl.app -dmg

      - name: Upload macOS DMG to Release
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: build/ElegooRemoteControl.dmg
          asset_name: ElegooRemoteControl-macOS.dmg
          asset_content_type: application/x-apple-diskimage
